---
- hosts: dcos_bootstrap

  tasks:
    - name: Create genconf directory
      file: path=/home/centos/genconf/ state=directory

    - name: Create configuration file
      blockinfile:
        dest: /home/centos/genconf/config.yaml
        create: yes
        state: present
        block: |
          ---
          bootstrap_url: http://{{ansible_default_ipv4.address}}:8181
          cluster_name: 'amt'
          exhibitor_storage_backend: static
          ip_detect_filename: /home/centos/genconf/ip-detect
          resolvers:
          - 8.8.4.4
          - 8.8.8.8
          master_list:
          - {{ hostvars[item].master_ip }}
      with_items: "{{ groups['dcos_master'] }}"

    - name: Create ip-detect script
      lineinfile: 
        dest: /home/centos/genconf/ip-detect
        create: yes
        state: present
        line: curl http://169.254.169.254/latest/meta-data/local-ipv4

    - name: Downloading DC/OS installer
      get_url: 
        url: https://downloads.dcos.io/dcos/EarlyAccess/dcos_generate_config.sh
        dest: /home/centos

    - name: Pull Docker NGINX
      command: docker pull nginx

    - name: Generate DC/OS build file
      shell: bash /home/centos/dcos_generate_config.sh

    - name: Run Docker Containet
      command: docker run -d -p 8181:80 -v $PWD/genconf/serve:/usr/share/nginx/html:ro nginx
      


